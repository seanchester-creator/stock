


<script>
  window.addEventListener('DOMContentLoaded', () => {
    // ---------- Helpers ----------
    const $  = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));
    const uid = () => {
      if (window.crypto?.getRandomValues) {
        const a = new Uint32Array(4); crypto.getRandomValues(a);
        return [...a].map(x=>x.toString(36)).join('').slice(0,20);
      }
      return Math.random().toString(36).slice(2, 22);
    };

    // ---------- Firebase (guarded) ----------
    let db = null;
    try {
      const firebaseConfig = {
        apiKey: "AIzaSyBwXtynA-NVN6xkEFS4n5C_AXwMxDUtlJE",
        authDomain: "tshirts-sonnys.firebaseapp.com",
        databaseURL: "https://tshirts-sonnys-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "tshirts-sonnys",
        storageBucket: "tshirts-sonnys.firebasestorage.app",
        messagingSenderId: "106241030509",
        appId: "1:106241030509:web:b546fa7eeae769f6694264"
      };
      // If firebase failed to load, this will throw and we‚Äôll skip DB wiring
      firebase.initializeApp(firebaseConfig);
      firebase.auth().signInAnonymously().catch(err => console.warn('Auth error', err));
      db = firebase.database();
    } catch (e) {
      console.warn('Firebase not available; UI will still work for local interactions.', e);
    }

    // ---------- State ----------
    const state = {
      sizes: ["Small","Medium","Large","XL","2XL","3XL","4XL"],
      colors: [
        "Black","White","Yellow (Daisy)","Yellow (Butter)","Navy","Royal Blue",
        "Brown","Red","Cherry Red","Sports Grey","Purple","Pink",
        "Pink (Heliconia)","Orange","Metro Blue","Green (Irish)","Green (Military)","Maroon"
      ],
      styles: ["standard","softstyle","mid softstyle","heavy cotton","ultra cotton"],
      brands: ["Gildan"],
      items: [] // {id,color,size,brand,style,notes,qty}
    };

    // ---------- Refs (only if DB exists) ----------
    const listsRef = db ? db.ref('lists') : null;
    const itemsRef = db ? db.ref('items') : null;

    // ---------- UI wiring (buttons will work even if DB fails) ----------
    let isAdmin = sessionStorage.getItem('tee.admin') === '1';

    function toggleAdmin(on){
      isAdmin = !!on;
      sessionStorage.setItem('tee.admin', on ? '1' : '0');
      toggleAdminUI(isAdmin);
    }

    function toggleAdminUI(on){
      $('#adminPanel').setAttribute('aria-hidden', on ? 'false' : 'true');
      $('#adminPanel').style.display = on ? '' : 'none';
      $('#loginBtn').textContent = on ? 'üö™ Sign out' : 'üîê Admin';
      $('#addQuick').style.display = on ? '' : 'none';
      const thActions = document.querySelector('.col-actions-header');
      if (thActions) thActions.style.display = on ? '' : 'none';
      $$('#tbody td.col-actions').forEach(td=> td.style.display = on ? '' : 'none');
      render();
    }

    // Login button + dialog (works even without Firebase)
    const loginDlg = $('#loginDialog');
    const loginPw  = $('#loginPassword');
    const ADMIN_PASSWORD = 'sonny';

    $('#loginBtn').addEventListener('click', () => {
      if (isAdmin) { toggleAdmin(false); return; }
      if (loginDlg?.showModal) {
        try { loginDlg.showModal(); setTimeout(()=>loginPw?.focus(), 0); }
        catch { fallbackPrompt(); }
      } else {
        fallbackPrompt();
      }
    });

    $('#loginForm').addEventListener('submit', (e)=>{
      e.preventDefault();
      const pw = (loginPw?.value || '');
      if (pw === ADMIN_PASSWORD){
        if (loginPw) loginPw.value='';
        if (loginDlg?.open) loginDlg.close();
        toggleAdmin(true);
      } else {
        alert('Wrong password');
      }
    });

    $('#loginSubmit').addEventListener('click', (e)=>{
      e.preventDefault();
      $('#loginForm').dispatchEvent(new Event('submit', {cancelable:true}));
    });

    function fallbackPrompt(){
      const pw = prompt('Enter admin password');
      if (pw === ADMIN_PASSWORD){ toggleAdmin(true); }
      else if (pw !== null) alert('Wrong password');
    }

    // ---------- Lists wiring ----------
    function fillOptions(sel, values, includeBlank=true){
      if (!sel) return;
      sel.innerHTML = (includeBlank?'<option value="">‚Äî</option>':'') + values.map(v=>`<option>${escapeHtml(v)}</option>`).join('');
    }
    function refreshLists(){
      if (!state.brands.includes("Gildan")) state.brands.unshift("Gildan");
      fillOptions($('#filterColor'), state.colors);
      fillOptions($('#filterSize'), state.sizes);
      fillOptions($('#filterBrand'), state.brands);
      fillOptions($('#filterStyle'), state.styles);
      fillOptions($('#newColor'), state.colors, false);
      fillOptions($('#newSize'), state.sizes, false);
      $('#newBrand').innerHTML = ('(unbranded)'+(state.brands.length?','+state.brands.join(','):'')).
        split(',').map(v=>`<option>${escapeHtml(v)}</option>`).join('');
      if ([...$('#newBrand').options].some(o=>o.value==='Gildan')) $('#newBrand').value = 'Gildan';
      fillOptions($('#newStyle'), state.styles, false);
      fillOptions($('#editColor'), state.colors, false);
      fillOptions($('#editSize'), state.sizes, false);
      $('#editBrand').innerHTML = ('(unbranded)'+(state.brands.length?','+state.brands.join(','):'')).
        split(',').map(v=>`<option>${escapeHtml(v)}</option>`).join('');
      fillOptions($('#editStyle'), state.styles, false);
    }

    // ---------- Sorting ----------
    let sortKey = 'color';
    let sortDir = 1;
    $$('#table th.sortable').forEach(th=> th.addEventListener('click', ()=>{
      const key = th.dataset.key;
      if (sortKey === key) sortDir *= -1; else { sortKey = key; sortDir = 1; }
      $$('#table th.sortable').forEach(x=>x.classList.remove('active'));
      th.classList.add('active');
      render();
    }));
    document.querySelector(`th.sortable[data-key="${sortKey}"]`)?.classList.add('active');

    // ---------- Render ----------
    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"}[c])); }

    function rowHtml(it){
      const notesCell = `<td class="col-notes">${it.notes ? escapeHtml(it.notes) : '<span class="muted">‚Äî</span>'}</td>`;
      const actions = `
        <div class="row" style="justify-content:flex-end">
          <button id="edit-${it.id}" class="iconbtn" title="Edit">‚úèÔ∏è</button>
          <button id="del-${it.id}" class="iconbtn" title="Delete">üóëÔ∏è</button>
        </div>`;
      return `<tr data-id="${it.id}">
        <td>${escapeHtml(it.color)}</td>
        <td>${escapeHtml(it.size)}</td>
        <td class="right">
          <div class="qty">
            ${isAdmin?`<button id="dec-${it.id}" class="iconbtn" title="Decrease">‚àí</button>`:''}
            <strong>${it.qty}</strong>
            ${isAdmin?`<button id="inc-${it.id}" class="iconbtn" title="Increase">Ôºã</button>`:''}
          </div>
        </td>
        <td>${escapeHtml(it.brand||'(unbranded)')}</td>
        <td>${escapeHtml(it.style)}</td>
        ${notesCell}
        <td class="right col-actions" style="display:${isAdmin?'':'none'}">${actions}</td>
      </tr>`;
    }

    function render(){
      const q = $('#search')?.value.trim().toLowerCase() || '';
      const fColor = $('#filterColor')?.value || '';
      const fSize  = $('#filterSize')?.value || '';
      const fBrand = $('#filterBrand')?.value || '';
      const fStyle = $('#filterStyle')?.value || '';
      const showNotes = $('#toggleNotes')?.checked || false;

      const rows = state.items
        .filter(it => (!fColor || it.color===fColor)
                   && (!fSize  || it.size===fSize)
                   && (!fBrand || it.brand===fBrand)
                   && (!fStyle || it.style===fStyle))
        .filter(it => !q || `${it.color} ${it.size} ${it.brand} ${it.style} ${it.notes||''}`.toLowerCase().includes(q))
        .sort((a,b)=>{
          let va=a[sortKey]??''; let vb=b[sortKey]??'';
          if (sortKey==='qty'){ va=+va; vb=+vb; }
          return (va>vb?1:va<vb?-1:0)*sortDir;
        });

      const tbody = $('#tbody');
      if (!tbody) return;
      if (!rows.length){
        tbody.innerHTML = `<tr><td colspan="7" class="muted" style="text-align:center;padding:24px">No items match your filters.</td></tr>`;
      } else {
        tbody.innerHTML = rows.map(it => rowHtml(it)).join('');
      }

      $('#thNotes').style.display = showNotes ? '' : 'none';
      $$('#tbody td.col-notes').forEach(td=> td.style.display = showNotes ? '' : 'none');

      $('#totalItems').textContent = rows.length;
      $('#totalQty').textContent = rows.reduce((s,it)=>s+Number(it.qty||0),0);
      $$('#tbody td.col-actions').forEach(el=> el.style.display = isAdmin ? '' : 'none');
    }

    // ---------- Delegated table actions (so buttons always work) ----------
    $('#tbody').addEventListener('click', (e)=>{
      const btn = e.target.closest('button'); if(!btn) return;

      if (!isAdmin && (btn.id?.startsWith('inc-') || btn.id?.startsWith('dec-') || btn.id?.startsWith('del-') || btn.id?.startsWith('edit-'))) {
        alert('Admin only'); return;
      }
      if (btn.id?.startsWith('inc-')) { adjQty(btn.id.slice(4), +1); }
      else if (btn.id?.startsWith('dec-')) { adjQty(btn.id.slice(4), -1); }
      else if (btn.id?.startsWith('del-')) { removeItem(btn.id.slice(4)); }
      else if (btn.id?.startsWith('edit-')) { openEdit(btn.id.slice(5)); }
    });

    // ---------- Filters/search toggle re-render ----------
    const wireUI = () => {
      const onChange = () => render();
      $('#search')?.addEventListener('input', onChange);
      $('#filterColor')?.addEventListener('change', onChange);
      $('#filterSize')?.addEventListener('change', onChange);
      $('#filterBrand')?.addEventListener('change', onChange);
      $('#filterStyle')?.addEventListener('change', onChange);
      $('#toggleNotes')?.addEventListener('change', onChange);
    };

    // ---------- CRUD helpers (guard DB) ----------
    function saveLists(){
      if (!db) return Promise.resolve();
      return db.ref('lists').set({
        sizes: state.sizes,
        colors: state.colors,
        styles: state.styles,
        brands: state.brands
      });
    }

    function upsertItem(obj){
      const id = obj.id || uid();
      const brand = (obj.brand ?? '').toString().trim() || 'Gildan';
      const clean = {...obj, id, brand, qty: Number(obj.qty||0), notes: (obj.notes||'')};
      if (!db) { // local fallback (no persistence)
        const i = state.items.findIndex(x=>x.id===id);
        if (i>=0) state.items[i]=clean; else state.items.push(clean);
        render(); return Promise.resolve();
      }
      return db.ref('items/'+id).set(clean);
    }

    function deleteItem(id){
      if (!db) {
        state.items = state.items.filter(x=>x.id!==id);
        render(); return Promise.resolve();
      }
      return db.ref('items/'+id).remove()
        .then(()=> console.log('Deleted', id))
        .catch(err => alert('Delete failed: ' + err.message));
    }

    function removeItem(id){
      const row = document.querySelector(`tr[data-id="${id}"]`);
      if (!confirm('Delete this row?')) return;
      if (row) row.classList.add('deleting');
      state.items = state.items.filter(x => x.id !== id);
      render();
      deleteItem(id);
    }

    function adjQty(id, delta){
      const it = state.items.find(x=>x.id===id); if(!it) return;
      const next = Math.max(0, Number(it.qty||0) + delta);
      if (!db) { it.qty = next; render(); return; }
      db.ref('items/'+id+'/qty').set(next);
    }

    // ---------- Edit dialog ----------
    let editingId = null;
    const dlg = $('#editDialog');

    function openEdit(id){
      editingId = id;
      const it = state.items.find(x=>x.id===id); if(!it) return;
      refreshLists();
      $('#editColor').value = it.color;
      $('#editSize').value  = it.size;
      $('#editBrand').value = it.brand?it.brand:'(unbranded)';
      $('#editStyle').value = it.style;
      $('#editQty').value   = it.qty;
      $('#editNotes').value = it.notes||'';
      dlg.showModal();
    }

    $('#saveEditBtn').addEventListener('click', (e)=>{
      e.preventDefault();
      if (!editingId) return dlg.close();
      const it = state.items.find(x=>x.id===editingId); if(!it) return;
      const color = $('#editColor').value;
      const size  = $('#editSize').value;
      const brandSel = $('#editBrand').value;
      const brand = brandSel==='(unbranded)'? '' : brandSel || 'Gildan';
      const style = $('#editStyle').value;
      const qty   = Math.max(0, Number($('#editQty').value||0));
      const notes = $('#editNotes').value.trim();
      upsertItem({...it, color, size, brand, style, qty, notes});
      addToList('colors', color);
      addToList('sizes',  size);
      addToList('styles', style);
      if (brand.trim()) addToList('brands', brand);
      saveLists();
      editingId = null; dlg.close();
    });

    dlg.addEventListener('close', ()=>{ editingId = null; });

    function addToList(listName, value){
      const v = String(value||'').trim();
      if (!v) return;
      const arr = state[listName];
      if (!arr.includes(v)) arr.push(v);
    }

    // ---------- Admin actions (buttons guaranteed to be wired) ----------
    $('#addItemBtn').addEventListener('click', ()=>{
      if (!isAdmin) return alert('Admin only');
      const color = $('#newColor').value;
      const size  = $('#newSize').value;
      const brandSel = $('#newBrand').value;
      const brand = brandSel === '(unbranded)' ? '' : (brandSel || 'Gildan');
      const style = $('#newStyle').value;
      const qty   = Number($('#newQty').value||0);
      const key = x=> `${x.color}|${x.size}|${x.brand}|${x.style}`;
      const existing = state.items.find(x=> key(x)===`${color}|${size}|${brand}|${style}`);
      if (existing){ upsertItem({...existing, qty}); }
      else upsertItem({id:uid(), color, size, brand, style, qty});
      addToList('colors', color);
      addToList('sizes',  size);
      if(brand.trim()) addToList('brands', brand);
      addToList('styles', style);
      saveLists();
      $('#newQty').value = 0;
    });

    $('#addQuick').addEventListener('click', ()=>{
      if (!isAdmin) return alert('Admin only');
      const def = {color: state.colors[0], size: state.sizes[0], brand: 'Gildan', style: state.styles[0], notes:'', qty:0};
      upsertItem({id:uid(), ...def});
    });

    // ---------- Live DB listeners (only if DB exists) ----------
    if (listsRef){
      listsRef.on('value', snap => {
        const v = snap.val() || {};
        state.sizes  = v.sizes  || state.sizes;
        state.colors = v.colors || state.colors;
        state.styles = v.styles || state.styles;
        const incomingBrands = v.brands || state.brands;
        const uniq = Array.from(new Set(incomingBrands));
        if (!uniq.includes("Gildan")) uniq.unshift("Gildan");
        state.brands = uniq;
        refreshLists(); render();
      });
    } else {
      // No DB? Still hydrate selects so UI is usable
      refreshLists(); render();
    }

    if (itemsRef){
      // Ensure every item has an id (fallback to DB key)
      itemsRef.on('value', snap => {
        const obj = snap.val() || {};
        state.items = Object.entries(obj).map(([key, it]) => ({ ...it, id: it?.id || key }));
        render();
      });

      // Optional one-time backfill (safe if it runs multiple times)
      (async function backfillIdsOnce(){
        try{
          const snap = await itemsRef.get();
          const obj = snap.val() || {};
          const updates = {};
          for (const [key, it] of Object.entries(obj)) {
            if (!it || it.id) continue;
            updates[`items/${key}/id`] = key;
          }
          if (Object.keys(updates).length){
            await db.ref().update(updates);
            console.log('Backfilled item ids:', Object.keys(updates).length);
          }
        } catch(e){
          console.warn('Backfill skipped:', e);
        }
      })();
    }

    // Initial UI setup
    toggleAdminUI(isAdmin);
    wireUI();
    render();
  });
</script>
